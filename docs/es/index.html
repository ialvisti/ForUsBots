<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>ForUsBots — API Docs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/docs/styles.css">
  <link rel="icon" type="image/png" href="/docs/images/icon.png">
</head>
<body>
  <header>
    <div class="wrap header-row">
      <h1>ForUsBots — API Docs</h1>
      <nav class="topnav">
        <a href="#overview">Overview</a>
        <a href="#base">Base URLs</a>
        <a href="#auth">Auth</a>
        <a href="#endpoints">Endpoints</a>
        <a href="#schemas">Schemas</a>
        <a href="#examples">Examples</a>
        <a href="#env">Env</a>
        <a href="#evidence">Evidence</a>
        <a href="#errors">Errors</a>
        <a href="#openapi">OpenAPI</a>
        <a href="/docs/api/es">API</a>

        <span class="spacer"></span>
        <div class="lang-switch">
          <label for="lang-select" class="sr-only">Language</label>
          <select id="lang-select" aria-label="Language">
            <option value="en" selected>EN</option>
            <option value="es">ES</option>
          </select>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section id="overview">
      <h2>Descripción general</h2>
      <p>Este servicio automatiza acciones en portales (actualmente: carga de documentos en el portal de empleadores de ForUsAll) usando Playwright. El servidor inicia sesión (TOTP cuando aplique), completa el formulario, envía el archivo y puede guardar capturas como evidencia. La API recibe el binario y metadatos mínimos (<code>x-meta</code>) y responde <em>202 Accepted</em> con un <code>jobId</code>.</p>
      <p class="small">Docs actualizadas: 2025-08-20</p>
    </section>

    <section id="base">
      <h2>URLs base</h2>
      <ul class="list">
        <li><span class="chip">DEV</span> <code>http://localhost:10000</code></li>
        <li><span class="chip">Render</span> <code>https://forusbots.onrender.com</code></li>
      </ul>
      <p>Todas las rutas de la API están bajo el namespace <code>/forusbot</code>.</p>
    </section>

    <section id="auth">
      <h2>Autenticación</h2>
      <p>Las rutas protegidas requieren el header <code>x-auth-token</code> igual a la variable <code>SHARED_TOKEN</code> del servidor. Si falta o no coincide → <code>401</code>.</p>
      <pre><code>x-auth-token: dev-secret</code></pre>
      <p class="small muted">Por defecto <code>/forusbot/status</code> es público; puedes exigir token cambiando <code>flags.statusPublic</code> con <code>PATCH /forusbot/settings</code>.</p>
    </section>

    <section id="endpoints">
      <h2>Endpoints</h2>
      <div class="grid grid-2">
        <div class="card">
          <div class="small"><strong>GET /forusbot/health</strong></div>
          <p class="muted">Sonda de vida.</p>
<pre><code>200 → {"ok":true}</code></pre>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/status</strong></div>
          <p class="muted">Snapshot de ejecución: colas, capacidad y candados de login.</p>
        </div>

        <div class="card">
          <div class="small"><strong>POST /forusbot/vault-file-upload</strong></div>
          <p class="muted">Crea un job de carga (cuerpo binario). Devuelve <code>202</code> con <code>jobId</code> y ETA.</p>
          <ul class="list">
            <li><strong>Headers</strong>: <code>x-auth-token</code> (req), <code>x-filename</code> (req), <code>x-meta</code> (JSON, req), <code>Content-Type</code>=<code>application/octet-stream</code> o <code>application/pdf</code></li>
          </ul>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/jobs</strong></div>
          <p class="muted">Lista de jobs con filtros (auth requerido).</p>
<pre><code>/forusbot/jobs?state=queued&botId=forusall&limit=50&offset=0</code></pre>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/jobs/:id</strong></div>
          <p class="muted">Detalle de un job (auth requerido).</p>
        </div>

        <div class="card">
          <div class="small"><strong>DELETE /forusbot/jobs/:id</strong></div>
          <p class="muted">Cancela un job en cola (auth requerido). Si ya está en ejecución → <code>409</code>.</p>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/locks</strong></div>
          <p class="muted">Estado de candados de login/TOTP por usuario.</p>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/settings</strong></div>
          <p class="muted">Lee settings (concurrencia y flags).</p>
        </div>

        <div class="card">
          <div class="small"><strong>PATCH /forusbot/settings</strong></div>
          <p class="muted">Actualiza settings. Campos útiles: <code>maxConcurrency</code>, <code>flags.statusPublic</code>.</p>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/metrics</strong></div>
          <p class="muted">Promedios por bot, totales y muestras.</p>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/version</strong></div>
          <p class="muted">Nombre/versión del paquete.</p>
        </div>

        <div class="card">
          <div class="small"><strong>GET /forusbot/openapi</strong></div>
          <p class="muted">YAML OpenAPI.</p>
        </div>
      </div>
    </section>

    <section id="jobs">
      <h2>Jobs API — estados y campos</h2>
      <ul class="list">
        <li><strong>Estados</strong>: <code>queued</code>, <code>running</code>, <code>succeeded</code>, <code>failed</code>, <code>canceled</code>.</li>
        <li><strong>Campos</strong>: <code>jobId</code>, <code>botId</code>, <code>meta</code>, <code>acceptedAt</code>, <code>startedAt</code>, <code>finishedAt</code>, <code>result</code>, <code>error</code>.</li>
        <li><strong>Métricas de ejecución</strong>: en cola → <code>waitingSeconds</code> y <code>position</code>; ejecutando → <code>elapsedSeconds</code> y etapa; terminado → <code>totalSeconds</code>.</li>
      </ul>
    </section>

    <section id="schemas">
      <h2>Esquemas</h2>

      <h3>x-meta (compartido)</h3>
<pre><code>{
  "planId": number,
  "formData": {
    "section": string,
    "caption": string,
    "captionOtherText"?: string,
    "status": string,
    "effectiveDate": "YYYY-MM-DD"
  },
  "options"?: {
    "returnEvidenceBase64"?: boolean,
    "saveEvidenceToTmp"?: boolean,
    "confirmDelayMs"?: number,
    "fastExit"?: boolean,
    "snifferWindowMs"?: number,
    "suppressSameUrlWarning"?: boolean,
    "evidenceOnSuccess"?: boolean,
    "skipPrevalidation"?: boolean
  }
}</code></pre>

      <h3>202 Accepted (submit)</h3>
<pre><code>{
  "ok": true,
  "jobId": "uuid",
  "acceptedAt": "....",
  "queuePosition": 3,
  "estimate": { "method":"lanes+movingAvg", ... },
  "capacitySnapshot": { ... }
}</code></pre>

      <h3>Job (GET /jobs/:id)</h3>
<pre><code>{
  "ok": true,
  "jobId": "...",
  "state": "running|...|failed",
  "error": null | "mensaje",
  "result": null | {...},
  "waitingSeconds"?: 4,
  "position"?: 1,
  "elapsedSeconds"?: 8,
  "stage"?: "login|otp|...|done",
  "stageSeconds"?: 2,
  "totalSeconds"?: 117
}</code></pre>
    </section>

    <section id="examples">
      <h2>Ejemplos cURL</h2>

      <div class="card spacey">
        <h3>Crear job (202)</h3>
<pre><code>META='{"planId":580,"formData":{"section":"CONTRACTS & AGREEMENTS","caption":"Recordkeeper Agreement","status":"Audit Ready","effectiveDate":"2025-05-02"}}'

curl -sS -X POST https://TU_URL/forusbot/vault-file-upload \
  -H 'x-auth-token: TU_TOKEN' \
  -H 'x-filename: presentation.pdf' \
  -H 'Content-Type: application/octet-stream' \
  -H "x-meta: $META" \
  --data-binary @presentation.pdf</code></pre>
      </div>

      <div class="card spacey">
        <h3>Consultar un job</h3>
<pre><code>curl -sS -H 'x-auth-token: TU_TOKEN' \
  https://TU_URL/forusbot/jobs/JOB_ID</code></pre>
      </div>

      <div class="card spacey">
        <h3>Listar jobs</h3>
<pre><code>curl -sS -H 'x-auth-token: TU_TOKEN' \
  'https://TU_URL/forusbot/jobs?state=queued&limit=20'</code></pre>
      </div>

      <div class="card spacey">
        <h3>Cancelar un job en cola</h3>
<pre><code>curl -sS -X DELETE -H 'x-auth-token: TU_TOKEN' \
  https://TU_URL/forusbot/jobs/JOB_ID</code></pre>
      </div>
    </section>

    <section id="env">
      <h2>Variables de entorno</h2>
<pre><code># Requeridas
PORT=10000
SHARED_TOKEN=dev-secret

# Credenciales del portal
SITE_USER=...
SITE_PASS=...
TOTP_SECRET=...        # Base32, sin espacios
TOTP_STEP_SECONDS=30

# Concurrencia & ETA
MAX_CONCURRENCY=3
ESTIMATE_AVG_SECONDS=120
ESTIMATE_AVG_WINDOW=10

# Evidencias
EVIDENCE_DIR=/tmp/evidence

# Playwright
HEADFUL=0             # 0=headless (recomendado en la nube), 1=mostrar navegador
SLOWMO=0              # ms por acción cuando HEADFUL=1
CLOSE_KILL_MS=1500</code></pre>
      <p class="small muted">El código usa <code>HEADFUL</code> (no <code>HEADLESS</code>). En producción usa <code>HEADFUL=0</code>.</p>
    </section>

    <section id="evidence">
      <h2>Evidencias</h2>
      <p>Las capturas se guardan en <code>/tmp/evidence</code>. En dev se exponen vía <code>GET /evidence/*</code>. En producción puedes deshabilitar el acceso público.</p>
    </section>

    <section id="errors">
      <h2>Errores & Warnings</h2>
      <ul class="list">
        <li><strong>400 Bad Request</strong> — <code>x-meta</code> inválido o falta el archivo.</li>
        <li><strong>401 Unauthorized</strong> — token inválido/ausente.</li>
        <li><strong>409 Conflict</strong> — intento de cancelar un job que ya está corriendo.</li>
        <li><strong>422 Unprocessable Entity</strong> — regla de negocio rechazada.</li>
        <li><strong>500</strong> — error inesperado.</li>
      </ul>
    </section>

    <section id="openapi">
      <h2>OpenAPI (YAML)</h2>
      <p>Consulta <code><a href="/docs/openapi.yaml">/docs/openapi.yaml</a></code> para importar en Swagger/Postman.</p>
    </section>

    <section id="changelog">
      <h2>Historial</h2>
      <ul class="list">
        <li><strong>2025-08-20</strong> — Namespace <code>/forusbot</code>, nuevos endpoints: <code>/jobs</code> (listar/cancelar), <code>/settings</code> (GET/PATCH), <code>/locks</code>, <code>/metrics</code>, <code>/version</code>, <code>/openapi</code>; docs ajustadas para <code>HEADFUL</code>.</li>
      </ul>
    </section>
  </main>

  <script>
  (function(){
    const sel = document.getElementById('lang-select');
    if (!sel) return;
    const isES = location.pathname.replace(/\/+$/,'').endsWith('/docs/es');
    sel.value = isES ? 'es' : 'en';
    sel.addEventListener('change', (e) => {
      const v = e.target.value;
      if (v === 'es') location.href = '/docs/es';
      else location.href = '/docs';
    });
  })();
  </script>
</body>
</html>