<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ForUsBots — API Docs (Multi-Bot)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/docs/styles.css" />
    <link rel="icon" type="image/png" href="/docs/images/icon.png" />
  </head>
  <body>
    <header>
      <div class="wrap header-row">
        <h1>ForUsBots — API Docs</h1>
        <nav class="topnav">
          <a href="#overview">Overview</a>
          <a href="#base">Base URLs</a>
          <a href="#auth">Auth</a>
          <a href="#endpoints">Endpoints</a>
          <a href="#schemas">Schemas</a>
          <a href="#examples">Examples</a>
          <a href="#env">Env</a>
          <a href="#evidence">Evidence</a>
          <a href="#errors">Errors</a>
          <a href="#openapi">OpenAPI</a>
          <a href="/docs/api">API</a>

          <span class="spacer"></span>
          <div class="lang-switch">
            <label for="lang-select" class="sr-only">Language</label>
            <select id="lang-select" aria-label="Language">
              <option value="en" selected>EN</option>
              <option value="es">ES</option>
            </select>
          </div>
        </nav>
      </div>
    </header>

    <main class="wrap">
      <section id="overview">
        <h2>Overview</h2>
        <p>
          This service automates portal actions (currently: ForUsAll employer
          portal document uploads) using Playwright. The server logs in (TOTP
          when required), fills the upload form, submits the file, and can store
          screenshots as evidence. A single HTTP API accepts the binary file
          plus minimal metadata (<code>x-meta</code>) and returns a
          <em>202 Accepted</em> with a <code>jobId</code>.
        </p>
        <p class="small">Docs updated: 2025-08-20</p>
      </section>

      <section id="base">
        <h2>Base URLs</h2>
        <ul class="list">
          <li>
            <span class="chip">DEV</span> <code>http://localhost:10000</code>
          </li>
          <li>
            <span class="chip">Render</span>
            <code>https://forusbots.onrender.com</code>
          </li>
        </ul>
        <p>All API routes are namespaced under <code>/forusbot</code>.</p>
      </section>

      <section id="auth">
        <h2>Authentication</h2>
        <p>
          Protected routes require header <code>x-auth-token</code> equal to
          server env <code>SHARED_TOKEN</code>. Missing/invalid token →
          <code>401</code>.
        </p>
        <pre><code>x-auth-token: dev-secret</code></pre>
        <p class="small muted">
          By default, <code>/forusbot/status</code> is public. You can require
          auth by toggling <code>flags.statusPublic</code> via
          <code>PATCH /forusbot/settings</code>.
        </p>
      </section>

      <section id="endpoints">
        <h2>Endpoints</h2>
        <div class="grid grid-2">
          <div class="card">
            <div class="small"><strong>GET /forusbot/health</strong></div>
            <p class="muted">Liveness probe.</p>
            <pre><code>200 → {"ok":true}</code></pre>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/status</strong></div>
            <p class="muted">
              Snapshot: running queue, waiting queue, capacity and login locks.
            </p>
            <pre><code>200 → {
  "ok": true,
  "running": [...],
  "queue": [...],
  "capacity": {...},
  "loginLocks": {...}
}</code></pre>
          </div>

          <div class="card">
            <div class="small">
              <strong>POST /forusbot/vault-file-upload</strong>
            </div>
            <p class="muted">
              Submit a new upload job (binary body). Returns
              <code>202</code> with <code>jobId</code> and ETA.
            </p>
            <ul class="list">
              <li>
                <strong>Headers</strong>: <code>x-auth-token</code> (req),
                <code>x-filename</code> (req), <code>x-meta</code> (JSON, req),
                <code>Content-Type</code>=<code>application/octet-stream</code>
                or <code>application/pdf</code>
              </li>
              <li><strong>Body</strong>: raw file bytes</li>
            </ul>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/jobs</strong></div>
            <p class="muted">List job records with filters (requires auth).</p>
            <pre><code>GET /forusbot/jobs?state=queued&botId=forusall&limit=50&offset=0</code></pre>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/jobs/:id</strong></div>
            <p class="muted">Get a single job (requires auth).</p>
          </div>

          <div class="card">
            <div class="small"><strong>DELETE /forusbot/jobs/:id</strong></div>
            <p class="muted">
              Cancel a queued job (requires auth). Returns 409 if already
              running.
            </p>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/locks</strong></div>
            <p class="muted">Inspect per-user login/TOTP locks.</p>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/settings</strong></div>
            <p class="muted">Read runtime settings (max concurrency, flags).</p>
          </div>

          <div class="card">
            <div class="small"><strong>PATCH /forusbot/settings</strong></div>
            <p class="muted">
              Patch settings. Useful fields: <code>maxConcurrency</code>,
              <code>flags.statusPublic</code>.
            </p>
            <pre><code>PATCH /forusbot/settings
Content-Type: application/json
x-auth-token: ...

{"maxConcurrency": 5}</code></pre>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/metrics</strong></div>
            <p class="muted">Averages per bot, totals, samples.</p>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/version</strong></div>
            <p class="muted">Package name/version.</p>
          </div>

          <div class="card">
            <div class="small"><strong>GET /forusbot/openapi</strong></div>
            <p class="muted">Raw OpenAPI YAML.</p>
          </div>

          <!-- NEW: Sandbox Dry-Run -->
          <div class="card">
            <div class="small">
              <strong
                >POST <code>/forusbot/sandbox/vault-file-upload</code></strong
              >
            </div>
            <p class="muted">
              Dry-run validator for uploads. Validates headers/body without
              creating a job.
            </p>
            <p class="small">
              <a href="/docs/api#sandbox-upload">Read docs →</a>
            </p>
          </div>

          <!-- NEW: Scrape Participant -->
          <div class="card">
            <div class="small">
              <strong>POST <code>/forusbot/scrape-participant</code></strong>
            </div>
            <p class="muted">
              Scrapes participant modules by participantId. 202 Accepted with
              jobId; supports return=data|html|text|both.
            </p>
            <p class="small">
              <a href="/docs/api#scrape-participant">Read docs →</a>
            </p>
          </div>

          <!-- NEW: Search Participants -->
          <div class="card">
            <div class="small">
              <strong>POST <code>/forusbot/search-participants</code></strong>
            </div>
            <p class="muted">
              Search by company/name/email/SSN last4/phone/participantId.
              Supports fetchAllPages/pageLimit/maxRows; returns normalized rows
              + pagination.
            </p>
            <p class="small">
              <a href="/docs/api#search-participants">Read docs →</a>
            </p>
          </div>

          <!-- NEW: MFA Reset -->
          <div class="card">
            <div class="small">
              <strong>POST <code>/forusbot/mfa-reset</code></strong>
            </div>
            <p class="muted">
              Triggers participant MFA reset. 202 Accepted with jobId; waits
              until status becomes ‘not enrolled’.
            </p>
            <p class="small"><a href="/docs/api#mfa-reset">Read docs →</a></p>
          </div>
        </div>
      </section>

      <h2 id="bots" class="tag">Bots</h2>
      <p class="muted">
        High-level overview of the automation bots. For full specs and response
        examples, follow each link to the API Reference.
      </p>

      <!-- Vault File Upload -->
      <section id="bot-vault-file-upload">
        <h3>Vault File Upload Bot</h3>
        <p>
          Automates secure PDF uploads to the ForUsAll Employer Portal. Accepts
          a binary body and metadata in headers; returns
          <code>202 Accepted</code> with a <code>jobId</code> for polling.
        </p>
        <h4>Endpoint</h4>
        <p><code>POST /forusbot/vault-file-upload</code> (auth)</p>
        <h4>Headers</h4>
        <table class="tbl">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Req</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>x-auth-token</code></td>
              <td>string</td>
              <td>yes</td>
              <td>Shared API token.</td>
            </tr>
            <tr>
              <td><code>x-filename</code></td>
              <td>string</td>
              <td>yes</td>
              <td>Original filename (e.g., <code>document.pdf</code>).</td>
            </tr>
            <tr>
              <td><code>x-meta</code></td>
              <td>JSON string</td>
              <td>yes</td>
              <td>
                Includes <code>planId</code> and <code>formData</code> (section,
                caption, status, effectiveDate).
              </td>
            </tr>
            <tr>
              <td><code>Content-Type</code></td>
              <td>enum</td>
              <td>yes</td>
              <td>
                <code>application/pdf</code> or
                <code>application/octet-stream</code>.
              </td>
            </tr>
          </tbody>
        </table>
        <h4>Body</h4>
        <p>Binary (the PDF file).</p>
        <h4>Responses</h4>
        <ul>
          <li>
            <strong>202</strong> Accepted — returns
            <code>{ ok, jobId, estimate, ... }</code>
          </li>
          <li><strong>400/401/422</strong> — validation/auth errors</li>
        </ul>
        <h4>Quick cURL</h4>
        <pre
          class="code"
        ><code>curl -X POST "$BASE/forusbot/vault-file-upload" \
  -H "x-auth-token: &lt;TOKEN&gt;" \
  -H "x-filename: document.pdf" \
  -H 'x-meta: {"planId":580,"formData":{"section":"CONTRACTS &amp; AGREEMENTS","caption":"Recordkeeper Agreement","status":"Audit Ready","effectiveDate":"2025-05-02"}}' \
  -H "Content-Type: application/pdf" \
  --data-binary @document.pdf</code></pre>
        <p><a href="/docs/api#vault-file-upload">Read full reference →</a></p>
      </section>

      <!-- Scrape Participant -->
      <section id="bot-scrape-participant">
        <h3>Scrape Participant Bot</h3>
        <p>
          Scrapes participant data by <code>participantId</code>. Supports
          selecting modules and return modes. Returns
          <code>202 Accepted</code> with a <code>jobId</code>; poll
          <code>/forusbot/jobs/:id</code> for results.
        </p>
        <h4>Endpoint</h4>
        <p><code>POST /forusbot/scrape-participant</code> (auth)</p>
        <h4>JSON Body</h4>
        <table class="tbl">
          <thead>
            <tr>
              <th>Field</th>
              <th>Type</th>
              <th>Req</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>participantId</code></td>
              <td>string</td>
              <td>yes</td>
              <td>Target participant.</td>
            </tr>
            <tr>
              <td><code>return</code></td>
              <td>enum</td>
              <td>no</td>
              <td>
                <code>data|html|text|both</code> (default <code>data</code>).
              </td>
            </tr>
            <tr>
              <td><code>strict</code></td>
              <td>boolean</td>
              <td>no</td>
              <td>Stricter parsing/guards.</td>
            </tr>
            <tr>
              <td><code>includeScreens</code></td>
              <td>boolean</td>
              <td>no</td>
              <td>Attach screenshots when available.</td>
            </tr>
            <tr>
              <td><code>timeoutMs</code></td>
              <td>number</td>
              <td>no</td>
              <td>Global timeout per run.</td>
            </tr>
            <tr>
              <td><code>modules</code></td>
              <td>array</td>
              <td>no</td>
              <td>
                List of module descriptors (e.g.,
                <code>[{"name":"profile"}]</code>).
              </td>
            </tr>
          </tbody>
        </table>
        <h4>Quick cURL</h4>
        <pre
          class="code"
        ><code>curl -X POST "$BASE/forusbot/scrape-participant" \
  -H "x-auth-token: &lt;TOKEN&gt;" -H "Content-Type: application/json" \
  -d '{"participantId":"12345","return":"data","strict":true,"modules":[{"name":"profile"}]}'</code></pre>
        <p><a href="/docs/api#scrape-participant">Read full reference →</a></p>
      </section>

      <!-- Search Participants -->
      <section id="bot-search-participants">
        <h3>Search Participants Bot</h3>
        <p>
          Searches participants with flexible criteria. Supports pagination
          controls and result limits; returns normalized rows and a pagination
          summary.
        </p>
        <h4>Endpoint</h4>
        <p><code>POST /forusbot/search-participants</code> (auth)</p>
        <h4>JSON Body</h4>
        <table class="tbl">
          <thead>
            <tr>
              <th>Path</th>
              <th>Type</th>
              <th>Req</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>criteria.companyName</code></td>
              <td>string</td>
              <td>no</td>
              <td>Filter by company name.</td>
            </tr>
            <tr>
              <td><code>criteria.fullName</code></td>
              <td>string</td>
              <td>no</td>
              <td>Filter by full name.</td>
            </tr>
            <tr>
              <td><code>criteria.email</code></td>
              <td>string</td>
              <td>no</td>
              <td>Email filter.</td>
            </tr>
            <tr>
              <td><code>criteria.ssn</code></td>
              <td>string</td>
              <td>no</td>
              <td>SSN (last 4 supported).</td>
            </tr>
            <tr>
              <td><code>criteria.phone</code></td>
              <td>string</td>
              <td>no</td>
              <td>Phone digits.</td>
            </tr>
            <tr>
              <td><code>criteria.participantId</code></td>
              <td>string</td>
              <td>no</td>
              <td>Exact id.</td>
            </tr>
            <tr>
              <td><code>options.fetchAllPages</code></td>
              <td>boolean</td>
              <td>no</td>
              <td>
                If true, iterates pages up to <code>pageLimit</code> and until
                <code>maxRows</code> is reached.
              </td>
            </tr>
            <tr>
              <td><code>options.pageLimit</code></td>
              <td>number</td>
              <td>no</td>
              <td>Hard cap on paged traversal (default 1).</td>
            </tr>
            <tr>
              <td><code>options.maxRows</code></td>
              <td>number</td>
              <td>no</td>
              <td>Maximum rows to return (default 25).</td>
            </tr>
            <tr>
              <td><code>options.timeoutMs</code></td>
              <td>number</td>
              <td>no</td>
              <td>Overall timeout.</td>
            </tr>
          </tbody>
        </table>
        <p class="muted">
          Note: If <code>maxRows</code> is small, the run may stop after the
          first page even with <code>fetchAllPages=true</code>.
        </p>
        <h4>Quick cURL</h4>
        <pre
          class="code"
        ><code>curl -X POST "$BASE/forusbot/search-participants" \
  -H "x-auth-token: &lt;TOKEN&gt;" -H "Content-Type: application/json" \
  -d '{"criteria":{"fullName":"miguel"},"options":{"fetchAllPages":true,"pageLimit":5,"maxRows":250}}'</code></pre>
        <p><a href="/docs/api#search-participants">Read full reference →</a></p>
      </section>

      <!-- MFA Reset -->
      <section id="bot-mfa-reset">
        <h3>MFA Reset Bot</h3>
        <p>
          Queues a participant MFA reset and waits until the status becomes
          <code>not enrolled</code>. Returns <code>202 Accepted</code> with
          <code>jobId</code>.
        </p>
        <h4>Endpoint</h4>
        <p><code>POST /forusbot/mfa-reset</code> (auth)</p>
        <h4>JSON Body</h4>
        <table class="tbl">
          <thead>
            <tr>
              <th>Field</th>
              <th>Type</th>
              <th>Req</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>participantId</code></td>
              <td>string</td>
              <td>yes</td>
              <td>Target participant id.</td>
            </tr>
          </tbody>
        </table>
        <h4>Quick cURL</h4>
        <pre class="code"><code>curl -X POST "$BASE/forusbot/mfa-reset" \
  -H "x-auth-token: &lt;TOKEN&gt;" -H "Content-Type: application/json" \
  -d '{"participantId":"12345"}'</code></pre>
        <p><a href="/docs/api#mfa-reset">Read full reference →</a></p>
      </section>

      <section id="jobs">
        <h2>Jobs API — states & fields</h2>
        <ul class="list">
          <li>
            <strong>States</strong>: <code>queued</code>, <code>running</code>,
            <code>succeeded</code>, <code>failed</code>, <code>canceled</code>.
          </li>
          <li>
            <strong>Fields</strong>: <code>jobId</code>, <code>botId</code>,
            <code>meta</code>, <code>acceptedAt</code>, <code>startedAt</code>,
            <code>finishedAt</code>, <code>result</code>, <code>error</code>.
          </li>
          <li>
            <strong>Runtime metrics</strong>: when queued →
            <code>waitingSeconds</code> & <code>position</code>; when running →
            <code>elapsedSeconds</code> & stage info; when finished →
            <code>totalSeconds</code>.
          </li>
        </ul>
      </section>

      <section id="schemas">
        <h2>Request & Response Schemas</h2>

        <h3>x-meta (shared)</h3>
        <pre><code>{
  "planId": number,
  "formData": {
    "section": string,
    "caption": string,
    "captionOtherText"?: string,
    "status": string,
    "effectiveDate": "YYYY-MM-DD"
  },
  "options"?: {
    "returnEvidenceBase64"?: boolean,
    "saveEvidenceToTmp"?: boolean,
    "confirmDelayMs"?: number,
    "fastExit"?: boolean,
    "snifferWindowMs"?: number,
    "suppressSameUrlWarning"?: boolean,
    "evidenceOnSuccess"?: boolean,
    "skipPrevalidation"?: boolean
  }
}</code></pre>

        <h3>202 Accepted (submit)</h3>
        <pre><code>{
  "ok": true,
  "jobId": "uuid",
  "acceptedAt": "2025-08-20T00:00:00Z",
  "queuePosition": 3,
  "estimate": {
    "method": "lanes+movingAvg",
    "avgDurationSeconds": 120,
    "startAt": "...",
    "finishAt": "..."
  },
  "capacitySnapshot": { ... }
}</code></pre>

        <h3>Job (GET /jobs/:id)</h3>
        <pre><code>{
  "ok": true,
  "jobId": "...",
  "state": "running|...|failed",
  "error": null | "message",
  "result": null | {...},
  "waitingSeconds"?: 4,
  "position"?: 1,
  "elapsedSeconds"?: 8,
  "stage"?: "login|otp|...|done",
  "stageSeconds"?: 2,
  "totalSeconds"?: 117
}</code></pre>
      </section>

      <section id="examples">
        <h2>cURL Examples</h2>

        <div class="card spacey">
          <h3>Submit upload (202)</h3>
          <pre><code>META='{"planId":580,"formData":{"section":"CONTRACTS & AGREEMENTS","caption":"Recordkeeper Agreement","status":"Audit Ready","effectiveDate":"2025-05-02"}}'

curl -sS -X POST https://YOUR_URL/forusbot/vault-file-upload \
  -H 'x-auth-token: YOUR_TOKEN' \
  -H 'x-filename: presentation.pdf' \
  -H 'Content-Type: application/octet-stream' \
  -H "x-meta: $META" \
  --data-binary @presentation.pdf</code></pre>
        </div>

        <div class="card spacey">
          <h3>Poll a job</h3>
          <pre><code>curl -sS -H 'x-auth-token: YOUR_TOKEN' \
  https://YOUR_URL/forusbot/jobs/JOB_ID</code></pre>
        </div>

        <div class="card spacey">
          <h3>List jobs</h3>
          <pre><code>curl -sS -H 'x-auth-token: YOUR_TOKEN' \
  'https://YOUR_URL/forusbot/jobs?state=queued&limit=20'</code></pre>
        </div>

        <div class="card spacey">
          <h3>Cancel a queued job</h3>
          <pre><code>curl -sS -X DELETE -H 'x-auth-token: YOUR_TOKEN' \
  https://YOUR_URL/forusbot/jobs/JOB_ID</code></pre>
        </div>

        <div class="card spacey">
          <h3>Toggle status visibility</h3>
          <pre><code>curl -sS -X PATCH https://YOUR_URL/forusbot/settings \
  -H 'x-auth-token: YOUR_TOKEN' \
  -H 'Content-Type: application/json' \
  -d '{"flags":{"statusPublic":false}}'</code></pre>
        </div>
      </section>

      <section id="env">
        <h2>Environment & Defaults</h2>
        <pre><code># Required
PORT=10000
SHARED_TOKEN=dev-secret

# Portal credentials
SITE_USER=...
SITE_PASS=...
TOTP_SECRET=...        # Base32, no spaces
TOTP_STEP_SECONDS=30

# Concurrency & ETA
MAX_CONCURRENCY=3
ESTIMATE_AVG_SECONDS=120
ESTIMATE_AVG_WINDOW=10

# Evidence
EVIDENCE_DIR=/tmp/evidence

# Playwright
HEADFUL=0             # 0=headless (recommended in cloud), 1=show browser locally
SLOWMO=0              # ms per action when HEADFUL=1
CLOSE_KILL_MS=1500</code></pre>
        <p class="small muted">
          The code uses <code>HEADFUL</code> (not <code>HEADLESS</code>). In
          production set <code>HEADFUL=0</code>.
        </p>
      </section>

      <section id="evidence">
        <h2>Evidence Files</h2>
        <p>
          Evidence screenshots go to <code>/tmp/evidence</code>. In dev they are
          served via <code>GET /evidence/*</code>. Disable public access in
          production if not needed.
        </p>
      </section>

      <section id="errors">
        <h2>Errors & Warnings</h2>
        <ul class="list">
          <li>
            <strong>400 Bad Request</strong> — invalid <code>x-meta</code>,
            missing file.
          </li>
          <li><strong>401 Unauthorized</strong> — bad/missing token.</li>
          <li>
            <strong>409 Conflict</strong> — cancel attempted on a running job.
          </li>
          <li>
            <strong>422 Unprocessable Entity</strong> — business rule rejection.
          </li>
          <li><strong>500</strong> — unexpected error.</li>
        </ul>
      </section>

      <section id="openapi">
        <h2>OpenAPI (YAML)</h2>
        <p>
          See
          <code><a href="/docs/openapi.yaml">/docs/openapi.yaml</a></code> to
          import into Swagger/Postman.
        </p>
      </section>

      <section id="changelog">
        <h2>Changelog</h2>
        <ul class="list">
          <li>
            <strong>2025-08-20</strong> — Namespaced <code>/forusbot</code>,
            added <code>/jobs</code> list & cancel,
            <code>/settings</code> (GET/PATCH), <code>/locks</code>,
            <code>/metrics</code>, <code>/version</code>, <code>/openapi</code>;
            docs updated for <code>HEADFUL</code>.
          </li>
        </ul>
      </section>
    </main>

    <script>
      (function () {
        const sel = document.getElementById("lang-select");
        if (!sel) return;
        const isES = location.pathname.replace(/\/+$/, "").endsWith("/docs/es");
        sel.value = isES ? "es" : "en";
        sel.addEventListener("change", (e) => {
          const v = e.target.value;
          location.href = v === "es" ? "/docs/es" : "/docs";
        });
      })();
    </script>
  </body>
</html>
