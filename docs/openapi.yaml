openapi: 3.0.3
info:
  title: ForUsBots API
  version: 2.3.0
servers:
  - url: http://localhost:10000
paths:
  /forusbot/health:
    get:
      summary: Health check
      responses:
        '200': { description: OK }

  /forusbot/status:
    get:
      summary: Global status snapshot
      description: |
        Si flags.statusPublic = false, requiere header x-auth-token.
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: false
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }

  /forusbot/jobs:
    get:
      summary: List jobs (queued/running/finished)
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
        - in: query
          name: state
          schema: { type: string, enum: [queued, running, succeeded, failed, canceled] }
        - in: query
          name: botId
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 500 }
        - in: query
          name: offset
          schema: { type: integer, minimum: 0 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [ok, total, limit, offset, jobs]
                properties:
                  ok: { type: boolean }
                  total: { type: integer }
                  limit: { type: integer }
                  offset: { type: integer }
                  jobs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'
        '401': { description: Unauthorized }

  /forusbot/jobs/{id}:
    get:
      summary: Get job by id
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '401': { description: Unauthorized }
        '404': { description: Not Found }
    delete:
      summary: Cancel queued job
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: Cancelled / Not Cancelled }
        '401': { description: Unauthorized }
        '404': { description: Not Found }
        '409': { description: Conflict (running) }

  /forusbot/locks:
    get:
      summary: View login/TOTP locks
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }

  /forusbot/settings:
    get:
      summary: Get runtime settings
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
    patch:
      summary: Patch runtime settings
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                maxConcurrency: { type: integer, minimum: 1 }
                flags:
                  type: object
                  properties:
                    statusPublic: { type: boolean }
      responses:
        '200': { description: OK }
        '400': { description: Bad Request }
        '401': { description: Unauthorized }

  /forusbot/metrics:
    get:
      summary: Runtime metrics
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }

  /forusbot/version:
    get:
      summary: Package version
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
  
  /forusbot/search-participants:
    post:
      summary: Search participants
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                criteria:
                  type: object
                  properties:
                    companyName: { type: string, nullable: true }
                    fullName:    { type: string, nullable: true }
                    email:       { type: string, nullable: true }
                    ssn:         { type: string, nullable: true, description: "last 4" }
                    phone:       { type: string, nullable: true }
                    participantId:{ type: string, nullable: true }
                options:
                  type: object
                  properties:
                    fetchAllPages:    { type: boolean }
                    pageLimit:        { type: integer, minimum: 1 }
                    maxRows:          { type: integer, minimum: 1 }
                    evidenceOnSuccess:{ type: boolean }
                    timeoutMs:        { type: integer, minimum: 1000 }
      responses:
        '202': { description: Accepted (returns jobId) }
        '400': { description: Bad Request }
        '401': { description: Unauthorized }
        '500': { description: Internal Server Error }

  /health:
    get:
      summary: Health check (plain)
      responses:
        '200': { description: OK }

  /forusbot/whoami:
    get:
      summary: Identity of current token
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }

  /forusbot/sandbox/vault-file-upload:
    post:
      summary: Dry-run validator for upload headers/body
      requestBody:
        required: false
        content:
          application/octet-stream:
            schema: { type: string, format: binary }
          application/pdf:
            schema: { type: string, format: binary }
      parameters:
        - in: header
          name: x-filename
          schema: { type: string }
          required: true
        - in: header
          name: x-meta
          schema: { type: string }
          required: true
      responses:
        '200': { description: OK }
        '400': { description: Bad Request }
        '422': { description: Unprocessable Entity }

  /forusbot/scrape-participant:
    post:
      summary: Enqueue participant scraping job
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                participantId: { type: string }
                return: { type: string, enum: [data, html, text, both] }
                strict: { type: boolean }
                includeScreens: { type: boolean }
                timeoutMs: { type: integer, minimum: 5000 }
                modules:
                  type: array
                  items:
                    oneOf:
                      - { type: string }
                      - type: object
                        properties:
                          key: { type: string }
                          fields:
                            type: array
                            items: { type: string }
      responses:
        '202': { description: Accepted (returns jobId) }
        '400': { description: Bad Request }
        '401': { description: Unauthorized }
        '422': { description: Validation failed }
        '500': { description: Internal Server Error }

  /forusbot/scrape-plan:
    post:
      summary: Enqueue plan scraping job
      description: |
        Extracts structured plan data from the ForUsAll employer portal. Supports extracting from 6 modules:
        basic_info (16 fields), plan_design (26 fields), onboarding (6 fields), communications (6 fields),
        extra_settings (10 fields), feature_flags (3 fields). Also extracts plan notes history.
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [planId]
              properties:
                planId:
                  type: string
                  description: Plan ID to scrape (e.g., "627")
                  example: "627"
                modules:
                  type: array
                  description: |
                    Modules to extract. Can be strings (extract all fields) or objects with field selection.
                    Available modules: basic_info, plan_design, onboarding, communications, extra_settings, feature_flags.
                    If empty or omitted, defaults to ["basic_info"].
                  items:
                    oneOf:
                      - type: string
                        description: Module key (extracts all fields from module)
                        example: "basic_info"
                      - type: object
                        description: Module with specific field selection
                        required: [key]
                        properties:
                          key:
                            type: string
                            description: Module key
                            example: "plan_design"
                          fields:
                            type: array
                            description: Specific fields to extract from this module
                            items:
                              type: string
                            example: ["record_keeper_id", "rk_plan_id"]
                  example: ["basic_info", {"key": "plan_design", "fields": ["record_keeper_id"]}]
                return:
                  type: string
                  enum: [data, html, text, both]
                  default: data
                  description: |
                    Return mode: 
                    - data: structured data only
                    - html: raw HTML only
                    - text: plain text only
                    - both: data + html + text
                strict:
                  type: boolean
                  default: false
                  description: If true, fail entire job if any module or field validation fails
                includeScreens:
                  type: boolean
                  default: false
                  description: Include screenshots in result (evidence)
                timeoutMs:
                  type: integer
                  minimum: 5000
                  default: 30000
                  description: Job timeout in milliseconds
            examples:
              allModules:
                summary: Extract all modules
                value:
                  planId: "627"
                  modules: ["basic_info", "plan_design", "onboarding", "communications", "extra_settings", "feature_flags"]
              specificModule:
                summary: Extract only basic info
                value:
                  planId: "627"
                  modules: ["basic_info"]
              specificFields:
                summary: Extract specific fields from modules
                value:
                  planId: "627"
                  modules:
                    - key: "basic_info"
                      fields: ["plan_id", "company_name", "ein", "status"]
                    - key: "plan_design"
                      fields: ["record_keeper_id", "enrollment_type"]
              withScreenshots:
                summary: Extract with evidence screenshots
                value:
                  planId: "627"
                  modules: ["basic_info", "plan_design"]
                  includeScreens: true
              strictMode:
                summary: Strict mode (fail on any error)
                value:
                  planId: "627"
                  modules: ["basic_info", "plan_design"]
                  strict: true
      responses:
        '202':
          description: Job accepted and queued
          content:
            application/json:
              schema:
                type: object
                required: [ok, jobId, acceptedAt, warnings, executedBy]
                properties:
                  ok:
                    type: boolean
                    example: true
                  jobId:
                    type: string
                    format: uuid
                    example: "f628e7c7-11b8-4419-9c30-29c572a99d81"
                  acceptedAt:
                    type: string
                    format: date-time
                    example: "2025-11-13T07:09:24.211Z"
                  queuePosition:
                    type: integer
                    example: 1
                  estimate:
                    type: object
                    properties:
                      startAt:
                        type: string
                        format: date-time
                      finishAt:
                        type: string
                        format: date-time
                  capacitySnapshot:
                    type: object
                    properties:
                      running: { type: integer }
                      queued: { type: integer }
                      maxConcurrency: { type: integer }
                  warnings:
                    type: array
                    description: Non-fatal warnings (e.g., invalid modules ignored)
                    items:
                      type: object
                      properties:
                        type: { type: string }
                        keys: { type: array, items: { type: string } }
                        unknown: { type: array, items: { type: string } }
                  executedBy:
                    type: object
                    properties:
                      name: { type: string, nullable: true }
                      role: { type: string }
                      at: { type: string, format: date-time }
        '400':
          description: Invalid request format
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: false }
                  error: { type: string, example: "planId es obligatorio" }
        '401':
          description: Missing or invalid authentication token
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: false }
                  error: { type: string, example: "unauthorized" }
        '422':
          description: Validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: false }
                  error: { type: string, example: "modules contiene claves no soportadas" }
                  invalid: { type: array, items: { type: string } }
                  allowed: { type: array, items: { type: string } }
                  fieldErrors:
                    type: array
                    items:
                      type: object
                      properties:
                        key: { type: string }
                        reason: { type: string }
                        details: { type: object }
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: false }
                  error: { type: string, example: "Internal Error" }

  /forusbot/mfa-reset:
    post:
      summary: Enqueue MFA reset for participant
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                participantId: { type: string }
              required: [participantId]
      responses:
        '202': { description: Accepted (returns jobId) }
        '400': { description: Bad Request }
        '401': { description: Unauthorized }
        '500': { description: Internal Server Error }

  /forusbot/openapi:
    get:
      summary: Serve this OpenAPI (YAML)
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      responses:
        '200':
          description: OK
          content:
            text/yaml: {}
        '401': { description: Unauthorized }

  /forusbot/vault-file-upload:
    post:
      summary: Accept a new upload job (202 Accepted)
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
        - in: header
          name: x-filename
          schema: { type: string }
          required: true
        - in: header
          name: x-meta
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema: { type: string, format: binary }
          application/pdf:
            schema: { type: string, format: binary }
      responses:
        '202': { description: Accepted (returns jobId and estimate) }
        '400': { description: Bad Request }
        '401': { description: Unauthorized }
        '422': { description: Unprocessable Entity }
        '500': { description: Internal Server Error }
    
  /forusbot/update-participant:
    post:
      summary: Update participant (Census tab) with note
      description: |
        Abre el perfil del participante y actualiza los campos indicados en *Census*. La **nota** es obligatoria y se envía en el modal de confirmación. El **éxito** se determina exclusivamente por la aparición del alert en `data-alerts="alerts"`.
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [participantId, note, updates]
              properties:
                participantId:
                  type: string
                  description: Portal participant ID
                note:
                  type: string
                  description: Nota obligatoria con el motivo del cambio
                updates:
                  type: object
                  description: Al menos 1 campo permitido
                  properties:
                    firstName: { type: string, nullable: true }
                    lastName: { type: string, nullable: true }
                    preferredFirstName: { type: string, nullable: true }
                    preferredLastName: { type: string, nullable: true }
                    eligibilityStatus:
                      type: string
                      enum: [A, D, I, X, U]
                    birthDate: { type: string, pattern: '^\d{4}-\d{2}-\d{2}$' }
                    hireDate: { type: string, pattern: '^\d{4}-\d{2}-\d{2}$' }
                    rehireDate: { type: string, pattern: '^\d{4}-\d{2}-\d{2}$', nullable: true }
                    terminationDate: { type: string, pattern: '^\d{4}-\d{2}-\d{2}$', nullable: true }
                    useProjectedEntryDefault: { type: boolean }
                    projectedPlanEntryDate: { type: string, pattern: '^\d{4}-\d{2}-\d{2}$', nullable: true }
                    address1: { type: string, nullable: true }
                    address2: { type: string, nullable: true }
                    city: { type: string, nullable: true }
                    state: { type: string, minLength: 2, maxLength: 2, nullable: true }
                    zipcode: { type: string, nullable: true }
                    email: { type: string, nullable: true }
                    homeEmail: { type: string, nullable: true }
                    phone: { type: string, nullable: true }
                options:
                  type: object
                  nullable: true
                  properties:
                    evidenceOnSuccess: { type: boolean }
                created_by:
                  type: string
                  nullable: true
      responses:
        '202': { description: Accepted (returns jobId) }
        '400': { description: Bad Request }
        '401': { description: Unauthorized }
        '500': { description: Internal Server Error }

  /forusbot/emailtrigger:
    post:
      summary: Trigger email communications to participants
      description: |
        Enqueues a job to trigger various types of email communications to plan participants through the ForUsAll portal.
        Supports multiple email types including statements, onboarding, sponsor quarterly emails, and generic communications.
        Always sends to all participants ("all").
      parameters:
        - in: header
          name: x-auth-token
          schema: { type: string }
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [planId, emailType]
              properties:
                planId:
                  type: integer
                  minimum: 1
                  description: Plan ID (must be positive integer)
                  example: 627
                emailType:
                  type: string
                  enum:
                    - monthly_balance
                    - onboard_communications
                    - new_hire_communications
                    - year_end_notice
                    - notify_auto-escalation
                    - summary_annual_notice
                    - statement_notice
                    - sponsor_quarterly_email
                    - generic_email
                    - force_out
                  description: Type of email to trigger
                  example: "statement_notice"
                participants:
                  type: string
                  enum: [all]
                  default: all
                  description: Participant selection (currently only "all" is supported)
                statement:
                  type: object
                  description: Required when emailType is "statement_notice"
                  properties:
                    year: { type: integer, example: 2025 }
                    quarter: { type: integer, minimum: 1, maximum: 4, example: 1 }
                    season: { type: string, example: "Q1" }
                sponsorQuarterly:
                  type: object
                  description: Required when emailType is "sponsor_quarterly_email"
                  required: [year, quarter, caNoteSubject, caNoteDetails, caUrl, quarterlyInvestmentReviewUrl, nextReviewDate, nextReviewTime]
                  properties:
                    year: { type: integer }
                    quarter: { type: integer, minimum: 1, maximum: 4 }
                    caNoteSubject: { type: string }
                    caNoteDetails: { type: string }
                    caUrl: { type: string, format: uri }
                    quarterlyInvestmentReviewUrl: { type: string, format: uri }
                    nextReviewDate: { type: string, pattern: '^\d{4}-\d{2}-\d{2}$', example: "2025-04-15" }
                    nextReviewTime: { type: string, pattern: '^\d{2}:\d{2}$', example: "14:30" }
                onboardOrNewHire:
                  type: object
                  description: Required when emailType is "onboard_communications" or "new_hire_communications"
                  properties:
                    rkType: { type: string, nullable: true, description: "Required for onboard_communications" }
                    planSnapshot: { type: string, nullable: true, description: "Required for onboard_communications" }
                    emailToSend: { type: string, default: "onboard_email" }
                    conversationId: { type: string, nullable: true }
                    attachments: { type: array, items: { type: string } }
                genericEmail:
                  type: object
                  description: Required when emailType is "generic_email"
                  required: [audience, subType]
                  properties:
                    audience:
                      type: object
                      properties:
                        enrolled: { type: boolean }
                        notEnrolled: { type: boolean }
                        terminated: { type: boolean }
                        ineligible: { type: boolean }
                        terminatedParticipants: { type: string, nullable: true }
                    planSnapshot: { type: string, nullable: true }
                    subType:
                      type: object
                      required: [kind]
                      properties:
                        kind:
                          type: string
                          enum: [onboard_communications, new_hire_communications, year_end_notice, notify_auto-escalation, summary_annual_notice, other]
                        otherText: { type: string, nullable: true, description: "Required when kind is 'other'" }
                        rkType: { type: string, nullable: true }
                        emailToSend: { type: string, nullable: true, description: "Required for onboard_communications and new_hire_communications" }
                        conversationId: { type: string, nullable: true }
                        attachments: { type: array, items: { type: string } }
                        terminatedParticipants: { type: string, nullable: true }
            examples:
              statementNotice:
                summary: Statement notice email
                value:
                  planId: 627
                  emailType: "statement_notice"
                  statement:
                    year: 2025
                    quarter: 1
                    season: "Q1"
              sponsorQuarterly:
                summary: Sponsor quarterly email
                value:
                  planId: 627
                  emailType: "sponsor_quarterly_email"
                  sponsorQuarterly:
                    year: 2025
                    quarter: 1
                    caNoteSubject: "Q1 2025 Update"
                    caNoteDetails: "Quarterly investment review details"
                    caUrl: "https://example.com/ca-note"
                    quarterlyInvestmentReviewUrl: "https://example.com/review"
                    nextReviewDate: "2025-04-15"
                    nextReviewTime: "14:30"
              genericEmail:
                summary: Generic email to enrolled participants
                value:
                  planId: 627
                  emailType: "generic_email"
                  genericEmail:
                    audience:
                      enrolled: true
                      notEnrolled: false
                      terminated: false
                      ineligible: false
                    subType:
                      kind: "summary_annual_notice"
      responses:
        '202':
          description: Job accepted and queued
          content:
            application/json:
              schema:
                type: object
                required: [ok, jobId, acceptedAt]
                properties:
                  ok: { type: boolean, example: true }
                  jobId: { type: string, format: uuid }
                  acceptedAt: { type: string, format: date-time }
                  queuePosition: { type: integer }
                  estimate:
                    type: object
                    properties:
                      startAt: { type: string, format: date-time }
                      finishAt: { type: string, format: date-time }
                  capacitySnapshot:
                    type: object
                    properties:
                      running: { type: integer }
                      queued: { type: integer }
                      maxConcurrency: { type: integer }
        '400':
          description: Invalid request format or missing required fields
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: false }
                  error: { type: string }
                  missing: { type: array, items: { type: string } }
        '401':
          description: Missing or invalid authentication token
        '500':
          description: Internal server error


components:
  schemas:
    ResultEnvelope:
      type: object
      required: [ok, code, data, warnings, errors]
      properties:
        ok: { type: boolean }
        code: { type: string, example: SEARCH_OK }
        message: { type: string, nullable: true }
        data:
          type: object
          nullable: true
          description: Payload normalizado por bot
        warnings:
          type: array
          items: {}
        errors:
          type: array
          items: {}

    StageEntry:
      type: object
      required: [name, startedAt, endedAt, durationMs, status]
      properties:
        name: { type: string }
        startedAt: { type: string, format: date-time }
        endedAt: { type: string, format: date-time }
        durationMs: { type: integer, minimum: 0 }
        status: { type: string, enum: [succeed, fail] }
        meta: { type: object, nullable: true }
        error:
          type: object
          nullable: true
          properties:
            name: { type: string }
            message: { type: string }
            stack: { type: string }

    Job:
      type: object
      required:
        [ ok, jobId, botId, state, acceptedAt, result, meta, stages ]
      properties:
        ok:
          type: boolean
          description: Siempre true para el wrapper de GET /jobs/:id; útil si se reutiliza en otras respuestas
          example: true
        jobId: { type: string, format: uuid }
        botId: { type: string }
        state: { type: string, enum: [queued, running, succeeded, failed, canceled] }
        acceptedAt: { type: string, format: date-time }
        startedAt: { type: string, format: date-time, nullable: true }
        finishedAt: { type: string, format: date-time, nullable: true }
        createdBy:
          type: object
          nullable: true
          properties:
            name: { type: string, nullable: true }
            role: { type: string, nullable: true }
            at:   { type: string, format: date-time, nullable: true }
        meta:
          type: object
          description: Meta sanitizada (sin selectors)
        result:
          $ref: '#/components/schemas/ResultEnvelope'
        error:
          type: string
          nullable: true
        stages:
          type: array
          description: Historial completo de stages del job
          items:
            $ref: '#/components/schemas/StageEntry'
        stagesSummaryMsByName:
          type: object
          additionalProperties: { type: integer }
          description: (Opcional) Suma de ms por nombre de stage
        waitingSeconds: { type: integer, nullable: true }
        position: { type: integer, nullable: true }
        elapsedSeconds: { type: integer, nullable: true }
        stage: { type: string, nullable: true }
        stageSince: { type: string, format: date-time, nullable: true }
        stageSeconds: { type: integer, nullable: true }
        stageMeta: { type: object, nullable: true }
        totalSeconds: { type: integer, nullable: true }
