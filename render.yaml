databases:
  - name: forusbots
    databaseName: forusbots
    user: alvisbot
    plan: basic
    region: oregon
    postgresMajorVersion: "17"
    ipAllowList: [] # solo red privada de Render

services:
  - type: web
    name: forusbots
    env: docker
    plan: standard
    autoDeploy: true
    dockerfilePath: ./Dockerfile

    healthCheckPath: /health
    healthCheckTimeout: 100

    envVars:
      # Modo y puerto
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000

      # üìú Logging estandarizado
      - key: LOG_LEVEL # debug | info | warn | error
        value: info
      - key: LOG_FORMAT # json | pretty
        value: json
      - key: SERVICE_NAME
        value: forusbots
      - key: LOG_MAX_META_CHARS
        value: 4000
      - key: LOG_MAX_ERR_STACK_CHARS
        value: 4000

      # Cookies seguras en prod
      - key: COOKIE_SECURE
        value: 1

      # üîê Secrets (definir en el Dashboard de Render)
      - key: SHARED_TOKEN
        sync: false
      - key: SITE_USER
        sync: false
      - key: SITE_PASS
        sync: false
      - key: TOTP_SECRET
        sync: false

      # ‚è±Ô∏è OTP / Concurrencia / Estimaciones
      - key: TOTP_STEP_SECONDS
        value: 30
      - key: MAX_CONCURRENCY
        value: 3
      - key: ESTIMATE_AVG_SECONDS
        value: 120
      - key: ESTIMATE_AVG_WINDOW
        value: 10

      # üñ•Ô∏è Headless (prod)
      - key: HEADLESS
        value: 1
      - key: HEADFUL
        value: 0
      - key: SLOWMO
        value: 0
      - key: CLOSE_KILL_MS
        value: 500

      # üç™ Contexto persistente + sesiones (en el disk)
      - key: PERSISTENT_CONTEXT
        value: 1
      - key: USER_DATA_DIR
        value: /var/lib/forusbots/user-data
      - key: SHARED_CONTEXT
        value: 1
      - key: PAGE_POOL_SIZE
        value: 3
      - key: MAX_IDLE_PAGES
        value: 1
      - key: KEEPALIVE_MS
        value: 30000

      # ‚ôªÔ∏è Reuso de storageState
      - key: SESSION_REUSE
        value: 1
      - key: SESSIONS_DIR
        value: /var/lib/forusbots/sessions
      - key: SESSION_TTL_HOURS
        value: 24

      # üö´ Evidencia por im√°genes desactivada (solo logs)
      - key: EVIDENCE_ENABLED
        value: 0
      - key: EVIDENCE_PUBLIC
        value: false
      - key: EVIDENCE_ADMIN_ONLY
        value: true

      # ‚ö° Bloqueo de recursos pesados (rendimiento)
      - key: SCRAPE_BLOCK_ASSETS
        value: 1
      - key: BLOCK_STYLESHEETS
        value: 1
      - key: BLOCK_THIRD_PARTY
        value: 1
      # - key: BLOCK_3P_LIST
      #   value: googletagmanager.com,google-analytics.com,...

      # ‚è±Ô∏è Timeouts
      - key: PW_DEFAULT_TIMEOUT
        value: 6000
      - key: SHELL_WAIT_MS
        value: 2500
      - key: OPEN_MODULE_TIMEOUT_MS
        value: 6000
      - key: PANEL_WAIT_MS
        value: 2500

      # üîå Postgres (inyectado desde el recurso "forusbots")
      - key: DATABASE_URL
        fromDatabase:
          name: forusbots
          property: connectionString
      - key: DATABASE_POOL_URL
        fromDatabase:
          name: forusbots
          property: pooledConnectionString
      - key: DB_SCHEMA
        value: public
      - key: PGSSLMODE
        value: require
      # Activa almacenamiento en DB si tu c√≥digo lo soporta (audit)
      - key: AUDIT_DB
        value: 1

    # üíæ Disco persistente para user-data y sessions (sobrevive deploys/restarts)
    disks:
      - name: forusbots-state
        mountPath: /var/lib/forusbots
        sizeGB: 7
