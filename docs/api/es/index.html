<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>ForUsBots — API Reference</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" href="/docs/images/icon.png" />
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="wrap header-row">
        <h1 class="title">ForUsBots — API Reference</h1>

        <!-- NUEVO: barra superior con volver + idioma -->
        <nav class="topnav">
          <a id="" class="toplink" href="/docs/sandbox/es">Sandbox</a>
          <span class="spacer"></span>

          <a id="back-link" class="toplink" href="/docs/es">Volver a Docs</a>
          <span class="spacer"></span>
          <label for="lang-select" class="sr-only">Idioma</label>
          <div class="lang-switch">
            <select id="lang-select" aria-label="Idioma">
              <option value="en">EN</option>
              <option value="es" selected>ES</option>
            </select>
          </div>
        </nav>
      </div>

      <div class="wrap meta-row">
        <div class="meta">
          <a class="muted small" href="/docs/openapi.yaml">openapi.yaml</a>
          <span class="badge">v2.2.0</span>
          <span class="badge alt">OAS 3.0</span>
        </div>
      </div>
    </header>

    <main class="wrap">
      <p class="lead">
        Endpoints REST mínimos que respaldan la automatización con Playwright.
        Envía un archivo para procesar de forma asíncrona, consulta el estado de
        los jobs, ajusta concurrencia y revisa locks y métricas.
        <br /><span class="muted small"
          >Todas las rutas están bajo el namespace <code>/forusbot</code>.
          También existe <code>/health</code> plano.</span
        >
      </p>

      <!-- =================== TAG: salud y estado =================== -->
      <h2 id="health-status" class="tag">salud &amp; estado</h2>

      <!-- GET /forusbot/health -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/health</span>
          <span class="sum">Chequeo de salud</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Sonda de vida. También disponible en <code>/health</code>.
          </p>
          <h4>Parámetros</h4>
          <div class="muted">Sin parámetros.</div>
          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{"ok": true}</code></pre>
          </div>
        </div>
      </details>

      <!-- GET /forusbot/status -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/status</span>
          <span class="sum">Snapshot de ejecución</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Vista de colas (running/queued), capacidad y candados de login/TOTP.
            Puede ser público o requerir token según
            <code>flags.statusPublic</code> (ver
            <code>PATCH /forusbot/settings</code>).
          </p>
          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "timestamp": "2025-08-20T00:00:00.000Z",
  "running": [...],
  "queue": [...],
  "summaryPorBot": { "forusall": { "running": 1, "queued": 1 } },
  "capacity": { "maxConcurrency": 3, "running": 1, "queued": 1, "slotsAvailable": 2 },
  "loginLocks": { "user@example.com": { "state": "free|locked", "queueSize": 0, "currentStep": 1234, "lastStepUsed": 1233, "lastStepAgeSeconds": 25 } },
  "totpStepSeconds": 30
}</code></pre>
          </div>
        </div>
      </details>

      <!-- GET /forusbot/whoami -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/whoami</span>
          <span class="sum">Identidad del token actual (auth)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Devuelve el rol y los metadatos de usuario asociados al token de API
            enviado. Envía el token mediante <code>x-auth-token</code> o
            <code>Authorization: Bearer &lt;token&gt;</code>.
          </p>

          <h4>Respuestas</h4>

          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "role": "admin",
  "isAdmin": true,
  "user": {
    "name": "Ivan Alvis",
    "email": "ivan.alvis@forusall.com",
    "id": "u_ivan"
  }
}</code></pre>
          </div>

          <div class="resp">
            <div class="code">401 <span class="muted">Unauthorized</span></div>
            <pre><code class="json">{"ok": false, "error": "unauthorized"}</code></pre>
          </div>
        </div>
      </details>

      <!-- =================== TAG: envío =================== -->
      <h2 id="submit" class="tag">envío</h2>

      <!-- POST /forusbot/vault-file-upload -->
      <details class="op post">
        <summary>
          <span class="method post">POST</span>
          <span class="path">/forusbot/vault-file-upload</span>
          <span class="sum">Enviar archivo (binario) → 202 Accepted</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Recibe el cuerpo binario (PDF/Octet-Stream) con metadatos en
            headers. El servidor inicia sesión (TOTP), completa el formulario y
            procesa el job de forma asíncrona. Devuelve <strong>202</strong> con
            <code>jobId</code> y ETA.
          </p>

          <h4>Parámetros (Headers)</h4>
          <table class="tbl">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Ubicación</th>
                <th>Tipo</th>
                <th>Req</th>
                <th>Descripción</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>x-auth-token</code></td>
                <td>header</td>
                <td>string</td>
                <td>sí</td>
                <td>
                  Debe coincidir con la variable <code>SHARED_TOKEN</code>.
                </td>
              </tr>
              <tr>
                <td><code>x-filename</code></td>
                <td>header</td>
                <td>string</td>
                <td>sí</td>
                <td>Nombre de archivo (para escritura temporal).</td>
              </tr>
              <tr>
                <td><code>x-meta</code></td>
                <td>header</td>
                <td>string (JSON)</td>
                <td>sí</td>
                <td>Ver esquema.</td>
              </tr>
              <tr>
                <td><code>Content-Type</code></td>
                <td>header</td>
                <td>enum</td>
                <td>sí</td>
                <td>
                  <code>application/octet-stream</code> o
                  <code>application/pdf</code>.
                </td>
              </tr>
            </tbody>
          </table>

          <h4>Request: <code>x-meta</code> (simplificado)</h4>
          <pre><code class="json">{
  "planId": 580,
  "formData": {
    "section": "CONTRACTS & AGREEMENTS",
    "caption": "Recordkeeper Agreement",
    "captionOtherText": "(requerido solo si caption = 'Other')",
    "status": "Audit Ready",
    "effectiveDate": "2025-05-02"
  },
  "options": {
    "confirmDelayMs": 5000,
    "fastExit": false,
    "snifferWindowMs": 7000,
    "evidenceOnSuccess": false
  }
}</code></pre>

          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">202 <span class="muted">Accepted</span></div>
            <pre><code class="json">{
  "ok": true,
  "jobId": "uuid",
  "acceptedAt": "2025-08-20T00:00:00.000Z",
  "queuePosition": 2,
  "estimate": { "method": "lanes+movingAvg", "avgDurationSeconds": 120, "startSeconds": 60, "finishSeconds": 180, "startAt": "...", "finishAt": "..." },
  "capacitySnapshot": { "maxConcurrency": 3, "running": 1, "queued": 1, "slotsAvailable": 2 }
}</code></pre>
          </div>
          <div class="resp">
            <div class="code">
              400 <span class="muted">Solicitud incorrecta</span>
            </div>
            <pre><code class="json">{"ok": false, "error": "Campos faltantes en x-meta"}</code></pre>
          </div>
          <div class="resp">
            <div class="code">401 <span class="muted">No autorizado</span></div>
            <pre><code class="json">{"ok": false, "error": "unauthorized"}</code></pre>
          </div>
          <div class="resp">
            <div class="code">
              422 <span class="muted">Entidad no procesable</span>
            </div>
            <pre><code class="json">{"ok": false, "error": "Status 'Document Missing' no es válido con archivo adjunto"}</code></pre>
          </div>
          <div class="resp">
            <div class="code">500 <span class="muted">Error interno</span></div>
            <pre><code class="json">{"ok": false, "error": "Unexpected runtime error"}</code></pre>
          </div>
        </div>
      </details>

      <!-- POST /forusbot/sandbox/vault-file-upload (dry-run) -->
      <details class="op post" id="sandbox-upload">
        <summary>
          <span class="method post">POST</span>
          <span class="path">/forusbot/sandbox/vault-file-upload</span>
          <span class="sum">Validar sin lanzar un job (dry-run)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Validador de prueba. No requiere auth. Valida
            <code>x-filename</code> y parsea/valida <code>x-meta</code>. Si se
            envía binario, solo se cuenta pero no se procesa. Devuelve
            <code>200</code> con eco normalizado o <code>4xx</code> ante errores
            de validación.
          </p>

          <h4>Parámetros (Headers)</h4>
          <table class="tbl">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Ubicación</th>
                <th>Tipo</th>
                <th>Req</th>
                <th>Descripción</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>x-filename</code></td>
                <td>header</td>
                <td>string</td>
                <td>sí</td>
                <td>Debe terminar en <code>.pdf</code>.</td>
              </tr>
              <tr>
                <td><code>x-meta</code></td>
                <td>header</td>
                <td>string (JSON)</td>
                <td>sí</td>
                <td>Misma forma que <code>x-meta</code> del upload.</td>
              </tr>
              <tr>
                <td><code>Content-Type</code></td>
                <td>header</td>
                <td>enum</td>
                <td>no</td>
                <td>
                  <code>application/octet-stream</code> o
                  <code>application/pdf</code> si se envía binario.
                </td>
              </tr>
            </tbody>
          </table>

          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "mode": "dry-run",
  "receivedBinaryBytes": 12345,
  "normalized": {
    "filename": "document.pdf",
    "meta": { "planId": 580, "formData": {"section":"CONTRACTS & AGREEMENTS", "caption":"Recordkeeper Agreement", "status":"Audit Ready", "effectiveDate":"2025-05-02"} }
  },
  "warnings": []
}</code></pre>
          </div>

          <div class="resp">
            <div class="code">
              400 <span class="muted">Solicitud incorrecta</span>
            </div>
            <pre><code class="json">{
  "ok": false,
  "errorType": "validation",
  "error": "Missing fields in x-meta",
  "missing": ["planId","formData.section","formData.caption","formData.status","formData.effectiveDate"],
  "warnings": []
}</code></pre>
          </div>

          <div class="resp">
            <div class="code">
              422 <span class="muted">Entidad no procesable</span>
            </div>
            <pre><code class="json">{
  "ok": false,
  "errorType": "validation",
  "error": "Status 'Document Missing' is not valid when a file is attached"
}</code></pre>
          </div>
        </div>
      </details>

      <!-- =================== TAG: participantes =================== -->
      <h2 id="participants" class="tag">participantes</h2>

      <!-- POST /forusbot/scrape-participant -->
      <details class="op post" id="scrape-participant">
        <summary>
          <span class="method post">POST</span>
          <span class="path">/forusbot/scrape-participant</span>
          <span class="sum">Extraer módulos de un participante (en cola)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Requiere auth (<code>x-auth-token</code>). Encola un job de scraping
            para un participante. Usa <code>GET /forusbot/jobs/:id</code> para
            consultar hasta completar.
          </p>

          <h4>Body</h4>
          <pre><code class="json">{
  "participantId": "12345",
  "return": "data|html|text|both",
  "strict": true,
  "includeScreens": false,
  "timeoutMs": 30000,
  "modules": [
    "census",
    { "key": "payroll", "fields": ["years:all", "2024", "2025"] }
  ]
}</code></pre>

          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">202 <span class="muted">Accepted</span></div>
            <pre><code class="json">{
  "ok": true,
  "jobId": "uuid",
  "acceptedAt": "date-time",
  "queuePosition": 1,
  "estimate": {"method":"lanes+movingAvg","avgDurationSeconds":120,...},
  "capacitySnapshot": {"maxConcurrency":3,"running":0,"queued":0,"slotsAvailable":3},
  "warnings": [
    { "type": "invalid_modules_ignored", "keys": ["unknown"] }
  ],
  "executedBy": { "name": "...", "role": "user|admin", "at": "date-time" }
}</code></pre>
          </div>
          <p class="muted small">
            La forma del resultado depende de los módulos seleccionados.
            Consulta <code>/forusbot/jobs/:id</code> hasta
            <code>state: "succeeded"</code>.
          </p>
        </div>
      </details>

      <!-- POST /forusbot/scrape-plan -->
      <details class="op post" id="scrape-plan">
        <summary>
          <span class="method post">POST</span>
          <span class="path">/forusbot/scrape-plan</span>
          <span class="sum">Extraer módulos de un plan (en cola)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Requiere auth (<code>x-auth-token</code>). Encola un job de scraping
            para un plan. Extrae datos estructurados de 6 módulos: basic_info (16 campos),
            plan_design (26 campos), onboarding (6 campos), communications (6 campos),
            extra_settings (10 campos), feature_flags (3 campos). También extrae el historial de notas del plan.
            Usa <code>GET /forusbot/jobs/:id</code> para consultar hasta completar.
          </p>

          <h4>Body</h4>
          <pre><code class="json">{
  "planId": "627",
  "return": "data|html|text|both",    // por defecto: "data"
  "strict": false,                     // fallar si hay error en módulo/campo
  "includeScreens": false,             // incluir capturas de evidencia
  "timeoutMs": 30000,
  "modules": [
    "basic_info",                      // extraer todos los campos
    { "key": "plan_design", "fields": ["record_keeper_id", "enrollment_type"] }
  ]
}</code></pre>

          <h4>Módulos Disponibles</h4>
          <table class="params">
            <thead>
              <tr>
                <th>Clave del Módulo</th>
                <th>Campos</th>
                <th>Descripción</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>basic_info</code></td>
                <td>16</td>
                <td>ID del plan, nombre de empresa, EIN, estado, fechas, gerentes</td>
              </tr>
              <tr>
                <td><code>plan_design</code></td>
                <td>26</td>
                <td>Record keeper, elegibilidad, contribuciones, inscripción, crypto</td>
              </tr>
              <tr>
                <td><code>onboarding</code></td>
                <td>6</td>
                <td>Primera fecha de diferimiento, fechas de blackout, fecha de activación</td>
              </tr>
              <tr>
                <td><code>communications</code></td>
                <td>6</td>
                <td>Texto DAVE, logo, participantes en español, e-statement, sorteo</td>
              </tr>
              <tr>
                <td><code>extra_settings</code></td>
                <td>10</td>
                <td>Modo de carga RK, año del plan, reglas de elegibilidad ER match</td>
              </tr>
              <tr>
                <td><code>feature_flags</code></td>
                <td>3</td>
                <td>Payroll X-Ray, problema de nómina, carga simple</td>
              </tr>
            </tbody>
          </table>

          <h4>Detalles de Campos</h4>
          <details class="nested">
            <summary><code>basic_info</code> campos (16 en total)</summary>
            <pre><code class="json">plan_id, version_id, symlink, sfdc_id, company_name, official_plan_name,
rm_id, im_id, service_type, plan_type, active, status, status_as_of,
is_3_16_only, ein, effective_date</code></pre>
          </details>

          <details class="nested">
            <summary><code>plan_design</code> campos (26 en total)</summary>
            <pre><code class="json">record_keeper_id, rk_plan_id, external_name, lt_plan_type,
accept_covid19_amendment, fund_lineup_id, enrollment_type,
eligibility_min_age, eligibility_duration_value, eligibility_duration_unit,
eligibility_hours_requirement, plan_entry_frequency,
plan_entry_frequency_first_month, plan_entry_frequency_second_month,
employer_contribution, er_contribution_monthly_cap, employer_contribution_cap,
employer_contribution_timing, employer_contribution_options_qaca,
default_savings_rate, contribution_type, autoescalate_rate,
support_aftertax, alts_crypto, alts_waitlist_crypto, max_crypto_percent_balance</code></pre>
          </details>

          <details class="nested">
            <summary><code>onboarding</code> campos (6 en total)</summary>
            <pre><code class="json">first_deferral_date, special_participation_date, enrollment_method,
blackout_begins_date, blackout_ends_date, website_live_date</code></pre>
          </details>

          <details class="nested">
            <summary><code>communications</code> campos (6 en total)</summary>
            <pre><code class="json">dave_text, logo, spanish_participants, e_statement, raffle_prize, raffle_date</code></pre>
          </details>

          <details class="nested">
            <summary><code>extra_settings</code> campos (10 en total)</summary>
            <pre><code class="json">rk_upload_mode, plan_year_start, er_contribution_eligibility,
er_match_eligibility_age, er_match_eligibility_duration_value,
er_match_eligibility_duration_unit, er_match_eligibility_hours_requirement,
er_match_plan_entry_frequency, er_match_plan_entry_frequency_first_month,
er_match_plan_entry_frequency_second_month</code></pre>
          </details>

          <details class="nested">
            <summary><code>feature_flags</code> campos (3 en total)</summary>
            <pre><code class="json">payroll_xray, payroll_issue, simple_upload</code></pre>
          </details>

          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">202 <span class="muted">Accepted</span></div>
            <pre><code class="json">{
  "ok": true,
  "jobId": "f628e7c7-11b8-4419-9c30-29c572a99d81",
  "acceptedAt": "2025-11-13T07:09:24.211Z",
  "queuePosition": 1,
  "estimate": {
    "method": "lanes+movingAvg",
    "avgDurationSeconds": 15,
    "startAt": "2025-11-13T07:09:24.211Z",
    "finishAt": "2025-11-13T07:09:39.211Z"
  },
  "capacitySnapshot": {
    "maxConcurrency": 3,
    "running": 0,
    "queued": 0,
    "slotsAvailable": 3
  },
  "warnings": [
    { "type": "invalid_modules_ignored", "keys": ["unknown_module"] }
  ],
  "executedBy": {
    "name": "John Doe",
    "role": "user",
    "at": "2025-11-13T07:09:24.211Z"
  }
}</code></pre>
          </div>

          <div class="resp">
            <div class="code">400 <span class="muted">Bad Request</span></div>
            <pre><code class="json">{
  "ok": false,
  "error": "planId es obligatorio"
}</code></pre>
          </div>

          <div class="resp">
            <div class="code">422 <span class="muted">Validación Fallida</span></div>
            <pre><code class="json">{
  "ok": false,
  "error": "modules contiene claves no soportadas",
  "invalid": ["invalid_module"],
  "allowed": ["basic_info", "plan_design", "onboarding", "communications", "extra_settings", "feature_flags"]
}</code></pre>
          </div>

          <h4>Resultado del Job (cuando es exitoso)</h4>
          <pre><code class="json">{
  "ok": true,
  "code": "OK",
  "message": null,
  "data": {
    "url": "https://employer.forusall.com/plans/627/edit",
    "planId": "627",
    "modulesRequested": [
      { "key": "basic_info", "fields": null },
      { "key": "plan_design", "fields": ["record_keeper_id"] }
    ],
    "modules": [
      {
        "key": "basic_info",
        "status": "ok",
        "source": "static",
        "requestedFields": null,
        "data": {
          "plan_id": "627",
          "company_name": "Revolution Foods, Inc.",
          "ein": "141955846",
          "status": "Terminated",
          "active": "false",
          "effective_date": "2021-07-01"
        },
        "extractorWarnings": [],
        "evidencePath": null
      },
      {
        "key": "plan_design",
        "status": "ok",
        "source": "static",
        "requestedFields": ["record_keeper_id"],
        "data": {
          "record_keeper_id": "Principal Financial Group"
        },
        "extractorWarnings": [],
        "evidencePath": null
      }
    ],
    "notes": [
      "Updating status and termination date based on the timeline provided...",
      "plan moved to principal",
      "Updated to calendar year"
    ],
    "full": null
  },
  "warnings": [],
  "errors": []
}</code></pre>

          <h4>Ejemplo: Extraer Todos los Módulos</h4>
          <pre><code class="bash">curl -X POST http://localhost:10000/forusbot/scrape-plan \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "planId": "627",
    "modules": [
      "basic_info",
      "plan_design",
      "onboarding",
      "communications",
      "extra_settings",
      "feature_flags"
    ]
  }'</code></pre>

          <h4>Ejemplo: Extraer Campos Específicos</h4>
          <pre><code class="bash">curl -X POST http://localhost:10000/forusbot/scrape-plan \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "planId": "627",
    "modules": [
      {
        "key": "basic_info",
        "fields": ["plan_id", "company_name", "ein", "status"]
      },
      {
        "key": "plan_design",
        "fields": ["record_keeper_id", "enrollment_type"]
      }
    ]
  }'</code></pre>

          <p class="muted small">
            <strong>Nota:</strong> Si <code>modules</code> está vacío u omitido, por defecto es <code>["basic_info"]</code>.
            El array <code>notes</code> siempre se extrae y contiene entradas del historial del plan.
            Usa <code>strict: true</code> para fallar todo el job si cualquier módulo o campo falla la validación.
          </p>

          <p class="muted small">
            <strong>Modos de retorno:</strong> 
            <code>data</code> (por defecto) retorna solo datos estructurados. 
            <code>html</code> retorna paneles HTML sin procesar. 
            <code>text</code> retorna texto plano. 
            <code>both</code> retorna data + html + text para cada módulo.
          </p>

          <p class="muted small">
            Relacionado: <a href="#scrape-participant">Extraer Participante</a>, 
            <a href="#jobs-get">Obtener Job</a>
          </p>
        </div>
      </details>

      <!-- POST /forusbot/search-participants -->
      <details class="op post" id="search-participants">
        <summary>
          <span class="method post">POST</span>
          <span class="path">/forusbot/search-participants</span>
          <span class="sum">Buscar participantes (en cola)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Requiere auth (<code>x-auth-token</code>). Normaliza criterios y
            opciones, inicia sesión, ejecuta la búsqueda en el portal y encola
            el job.
          </p>

          <h4>Body</h4>
          <pre><code class="json">{
  "criteria": {
    "companyName": "Acme Inc.",
    "fullName": "Jane Doe",
    "email": "jane@acme.com",
    "ssn": "1234",                 // últimos 4 (o 9)
    "phone": "4155551234",         // 10 dígitos
    "participantId": "98765"
  },
  "options": {
    "fetchAllPages": true,
    "pageLimit": 3,
    "maxRows": 60,
    "timeoutMs": 12000,
    "evidenceOnSuccess": false
  }
}</code></pre>

          <p class="muted small">
            Interacción: cuando <code>fetchAllPages=true</code>, el bot avanza
            por páginas hasta <code>pageLimit</code>.
            <code>maxRows</code> limita el total de filas devueltas. La
            respuesta inmediata es <code>202 Accepted</code> con
            <code>jobId</code>; el resultado final del job incluye las filas y
            la paginación mostrada abajo.
          </p>

          <h4>Aceptado (202)</h4>
          <div class="resp">
            <div class="code">202 <span class="muted">Accepted</span></div>
            <pre><code class="json">{
  "ok": true,
  "jobId": "uuid",
  "acceptedAt": "date-time",
  "queuePosition": 1,
  "estimate": {"method":"lanes+movingAvg","avgDurationSeconds":120,...},
  "capacitySnapshot": {"maxConcurrency":3,"running":0,"queued":0,"slotsAvailable":3}
}</code></pre>
          </div>

          <h4>Resultado del job (cuando finaliza)</h4>
          <pre><code class="json">{
  "ok": true,
  "targetUrl": "https://employer.forusall.com/view_participants",
  "criteriaEcho": {"companyName": "Acme Inc.", "fullName": "Jane Doe", "email": "jane@acme.com", "ssn": "1234", "phone": "4155551234", "participantId": "98765"},
  "pagination": {
    "pagesFetched": 2,
    "pageLimit": 3,
    "estimatedTotal": 125,
    "hasNextPage": true,
    "shownText": "Showing 1 to 25 of 125 entries"
  },
  "count": 50,
  "rows": [
    {
      "planName": "Acme 401(k)",
      "planId": "580",
      "firstName": "Jane",
      "lastName": "Doe",
      "participantId": "98765",
      "last4Ssn": "1234",
      "status": "Eligible",
      "rmContact": "RM Name",
      "opsContact": "Ops Name"
    }
  ],
  "evidencePath": "/tmp/evidence/search-participants_after_....png"
}</code></pre>
        </div>
      </details>

      <!-- POST /forusbot/mfa-reset -->
      <details class="op post" id="mfa-reset">
        <summary>
          <span class="method post">POST</span>
          <span class="path">/forusbot/mfa-reset</span>
          <span class="sum">Reset de MFA para un participante (en cola)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Requiere auth (<code>x-auth-token</code>). Dispara el reset de MFA
            de un participante y espera a que el estado sea
            <code>not enrolled</code>. Devuelve 202 y puedes seguir el progreso
            vía la Jobs API.
          </p>

          <h4>Body</h4>
          <pre><code class="json">{ "participantId": "12345" }</code></pre>

          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">202 <span class="muted">Accepted</span></div>
            <pre><code class="json">{
  "ok": true,
  "jobId": "uuid",
  "acceptedAt": "date-time",
  "queuePosition": 1,
  "estimate": {"method":"lanes+movingAvg","avgDurationSeconds":120,...},
  "capacitySnapshot": {"maxConcurrency":3,"running":0,"queued":0,"slotsAvailable":3},
  "botId": "forusall-mfa-reset",
  "meta": { "participantId": "12345", "participantUrl": "https://employer.forusall.com/participants/12345" }
}</code></pre>
          </div>
          <p class="muted small">
            Consulta <code>/forusbot/jobs/:id</code> hasta que el job finalice.
          </p>
        </div>
      </details>

      <!-- =================== TAG: jobs =================== -->
      <h2 id="jobs" class="tag">jobs</h2>

      <!-- GET /forusbot/jobs -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/jobs</span>
          <span class="sum">Listar jobs (auth)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Filtros:
            <code>state</code> (queued|running|succeeded|failed|canceled),
            <code>botId</code>, <code>limit</code>, <code>offset</code>.
          </p>
          <h4>Parámetros (Query)</h4>
          <table class="tbl">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Ubicación</th>
                <th>Tipo</th>
                <th>Req</th>
                <th>Descripción</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>state</code></td>
                <td>query</td>
                <td>string</td>
                <td>no</td>
                <td>Filtra por estado.</td>
              </tr>
              <tr>
                <td><code>botId</code></td>
                <td>query</td>
                <td>string</td>
                <td>no</td>
                <td>Filtra por bot (p. ej. <code>forusall</code>).</td>
              </tr>
              <tr>
                <td><code>limit</code></td>
                <td>query</td>
                <td>integer</td>
                <td>no</td>
                <td>Máximo de ítems (defecto 50, máximo 500).</td>
              </tr>
              <tr>
                <td><code>offset</code></td>
                <td>query</td>
                <td>integer</td>
                <td>no</td>
                <td>Desplazamiento (paginación).</td>
              </tr>
            </tbody>
          </table>

          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "total": 123,
  "limit": 50,
  "offset": 0,
  "jobs": [
    {
      "jobId": "uuid",
      "botId": "forusall",
      "meta": {...},
      "state": "succeeded",
      "acceptedAt": "2025-08-20T00:00:00Z",
      "startedAt": "2025-08-20T00:00:30Z",
      "finishedAt": "2025-08-20T00:02:00Z",
      "result": {...},
      "error": null
    }
  ]
}</code></pre>
          </div>
          <div class="resp">
            <div class="code">401 <span class="muted">No autorizado</span></div>
            <pre><code class="json">{"ok": false, "error": "unauthorized"}</code></pre>
          </div>
        </div>
      </details>

      <!-- GET /forusbot/jobs/:id -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/jobs/:id</span>
          <span class="sum">Obtener job por id (auth)</span>
        </summary>
        <div class="op-body">
          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "jobId": "uuid",
  "botId": "forusall",
  "meta": {...},
  "state": "running",
  "acceptedAt": "...",
  "startedAt": "...",
  "finishedAt": null,
  "result": null,
  "error": null,
  "elapsedSeconds": 18,
  "stage": "upload-file",
  "stageSince": "2025-08-20T00:01:18Z",
  "stageSeconds": 3
}</code></pre>
          </div>
          <div class="resp">
            <div class="code">401 <span class="muted">No autorizado</span></div>
            <pre><code class="json">{"ok": false, "error": "unauthorized"}</code></pre>
          </div>
          <div class="resp">
            <div class="code">404 <span class="muted">No encontrado</span></div>
            <pre><code class="json">{"ok": false, "error": "Job no encontrado"}</code></pre>
          </div>
        </div>
      </details>

      <!-- DELETE /forusbot/jobs/:id -->
      <details class="op del">
        <summary>
          <span class="method del">DELETE</span>
          <span class="path">/forusbot/jobs/:id</span>
          <span class="sum">Cancelar job en cola (auth)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Solo se pueden cancelar jobs en cola. Si el job ya está ejecutándose
            → 409.
          </p>
          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{"ok": true, "canceled": true, "reason": "queued"}</code></pre>
          </div>
          <div class="resp">
            <div class="code">409 <span class="muted">Conflicto</span></div>
            <pre><code class="json">{"ok": false, "error": "No se puede cancelar: job en ejecución"}</code></pre>
          </div>
          <div class="resp">
            <div class="code">404 <span class="muted">No encontrado</span></div>
            <pre><code class="json">{"ok": false, "error": "Job no encontrado"}</code></pre>
          </div>
        </div>
      </details>

      <!-- =================== TAG: admin =================== -->
      <h2 id="admin" class="tag">admin</h2>

      <!-- GET /forusbot/locks -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/locks</span>
          <span class="sum">Candados de Login/TOTP (auth)</span>
        </summary>
        <div class="op-body">
          <p class="muted">Mutex por usuario y ventana TOTP.</p>
          <h4>Respuestas</h4>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "stepSeconds": 30,
  "locks": {
    "user@example.com": {
      "state": "free|locked",
      "queueSize": 0,
      "currentStep": 1234,
      "lastStepUsed": 1233,
      "lastStepAgeSeconds": 25
    }
  }
}</code></pre>
          </div>
        </div>
      </details>

      <!-- GET /forusbot/settings -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/settings</span>
          <span class="sum">Leer settings (auth)</span>
        </summary>
        <div class="op-body">
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "settings": { "maxConcurrency": 3, "flags": { "statusPublic": true } },
  "capacity": { "maxConcurrency": 3, "running": 0, "queued": 0, "slotsAvailable": 3 }
}</code></pre>
          </div>
        </div>
      </details>

      <!-- PATCH /forusbot/settings -->
      <details class="op patch">
        <summary>
          <span class="method patch">PATCH</span>
          <span class="path">/forusbot/settings</span>
          <span class="sum">Actualizar settings (auth)</span>
        </summary>
        <div class="op-body">
          <p class="muted">Ejemplo de body:</p>
          <pre><code class="json">{"maxConcurrency": 5, "flags": {"statusPublic": false}}</code></pre>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "changed": ["maxConcurrency","flags.statusPublic"],
  "previous": { "maxConcurrency": 3, "flags": {"statusPublic": true} },
  "settings":  { "maxConcurrency": 5, "flags": {"statusPublic": false} },
  "capacity":  { "maxConcurrency": 5, "running": 0, "queued": 0, "slotsAvailable": 5 }
}</code></pre>
          </div>
          <div class="resp">
            <div class="code">
              400 <span class="muted">Solicitud incorrecta</span>
            </div>
            <pre><code class="json">{"ok": false, "error": "maxConcurrency debe ser un número >= 1"}</code></pre>
          </div>
        </div>
      </details>

      <!-- GET /forusbot/metrics -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/metrics</span>
          <span class="sum">Métricas (auth)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Promedios por bot, totales y muestras usadas para ETA.
          </p>
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{
  "ok": true,
  "timestamp": "2025-08-20T00:00:00Z",
  "totals": { "running": 1, "queued": 2, "finished": 10, "maxConcurrency": 3 },
  "byBot": {
    "forusall": {
      "running": 1,
      "queued": 2,
      "avgDurationSeconds": 118,
      "samples": [120, 115, 119]
    }
  }
}</code></pre>
          </div>
        </div>
      </details>

      <!-- GET /forusbot/version -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/version</span>
          <span class="sum">Versión del paquete (auth)</span>
        </summary>
        <div class="op-body">
          <div class="resp">
            <div class="code">200 <span class="muted">OK</span></div>
            <pre><code class="json">{"ok": true, "name": "file-upload-bot", "version": "1.0.0"}</code></pre>
          </div>
        </div>
      </details>

      <!-- GET /forusbot/openapi -->
      <details class="op get">
        <summary>
          <span class="method get">GET</span>
          <span class="path">/forusbot/openapi</span>
          <span class="sum">OpenAPI YAML (auth)</span>
        </summary>
        <div class="op-body">
          <p class="muted">
            Devuelve el <code>openapi.yaml</code> crudo (text/yaml).
          </p>
        </div>
      </details>

      <!-- =================== TAG: esquemas =================== -->
      <h2 id="schemas" class="tag">esquemas</h2>

      <details class="schema">
        <summary><strong>x-meta</strong></summary>
        <pre><code class="json">{
  "planId": number,
  "formData": {
    "section": string,
    "caption": string,
    "captionOtherText"?: string,
    "status": string,
    "effectiveDate": "YYYY-MM-DD"
  },
  "options"?: {
    "returnEvidenceBase64"?: boolean,
    "saveEvidenceToTmp"?: boolean,
    "confirmDelayMs"?: number,
    "fastExit"?: boolean,
    "snifferWindowMs"?: number,
    "suppressSameUrlWarning"?: boolean,
    "evidenceOnSuccess"?: boolean,
    "skipPrevalidation"?: boolean
  }
}</code></pre>
      </details>

      <details class="schema">
        <summary><strong>202 Accepted (submit)</strong></summary>
        <pre><code class="json">{
  "ok": true,
  "jobId": "uuid",
  "acceptedAt": "date-time",
  "queuePosition": 1,
  "estimate": {
    "method": "lanes+movingAvg",
    "avgDurationSeconds": 120,
    "startSeconds": 0,
    "finishSeconds": 120,
    "startAt": "date-time",
    "finishAt": "date-time"
  },
  "capacitySnapshot": {
    "maxConcurrency": 3,
    "running": 0,
    "queued": 0,
    "slotsAvailable": 3
  }
}</code></pre>
      </details>

      <details class="schema">
        <summary><strong>Job (GET /jobs/:id)</strong></summary>
        <pre><code class="json">{
  "ok": true,
  "jobId": "uuid",
  "botId": "string",
  "meta": {},
  "state": "queued|running|succeeded|failed|canceled",
  "acceptedAt": "date-time",
  "startedAt": "date-time|null",
  "finishedAt": "date-time|null",
  "result": "object|null",
  "error": "string|null",
  "waitingSeconds"?: 0,
  "position"?: 1,
  "elapsedSeconds"?: 0,
  "stage"?: "string",
  "stageSince"?: "date-time",
  "stageSeconds"?: 0,
  "totalSeconds"?: 0
}</code></pre>
      </details>

      <footer class="foot muted small">
        Última actualización 2025-08-20 • Docs estáticas. En nube usa
        <code>HEADFUL=0</code>.
      </footer>
    </main>

    <script>
      (function () {
        var isES = location.pathname
          .replace(/\/+$/, "")
          .endsWith("/docs/api/es");
        var sel = document.getElementById("lang-select");
        if (sel) {
          sel.value = isES ? "es" : "en";
          sel.addEventListener("change", function (e) {
            var v = e.target.value;
            location.href = v === "es" ? "/docs/api/es" : "/docs/api";
          });
        }
        var back = document.getElementById("back-link");
        if (back) back.href = isES ? "/docs/es" : "/docs";
      })();
    </script>
  </body>
</html>
